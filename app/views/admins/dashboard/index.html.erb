<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚·ãƒ•ãƒˆç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid white;
      padding: 0.5rem 1.5rem;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.3s;
    }
    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }
    .container {
      max-width: 1400px;
      margin: 2rem auto;
      padding: 0 2rem;
    }
    .controls {
      background: white;
      padding: 1.5rem;
      border-radius: 10px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .month-selector {
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .month-selector select {
      padding: 0.5rem 1rem;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }
    .shift-table-container {
      background: white;
      border-radius: 10px;
      padding: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      overflow-x: auto;
    }
    .shift-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }
    .shift-table th,
    .shift-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    .shift-table th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }
    .shift-table tr:hover {
      background: #f8f9fa;
    }
    .loading {
      text-align: center;
      padding: 3rem;
      color: #667eea;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>ğŸ“… ã‚·ãƒ•ãƒˆç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <div>
        <%= link_to "QRã‚³ãƒ¼ãƒ‰è¡¨ç¤º", root_path, class: "logout-btn", style: "margin-right: 1rem;" %>
        <%= link_to "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", destroy_admin_session_path, data: { turbo_method: :delete }, class: "logout-btn" %>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="controls">
      <div class="month-selector">
        <label for="month-select">è¡¨ç¤ºæœˆ:</label>
        <select id="month-select">
          <!-- JavaScript ã§å‹•çš„ã«ç”Ÿæˆ -->
        </select>
        <button onclick="loadShiftData()" style="padding: 0.5rem 1.5rem; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">èª­ã¿è¾¼ã¿</button>
      </div>
    </div>

    <div class="shift-table-container">
      <div id="shift-content">
        <p class="loading">æœˆã‚’é¸æŠã—ã¦ã€Œèª­ã¿è¾¼ã¿ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</p>
      </div>
    </div>
  </div>

  <script>
    const GAS_API_URL = "<%= ENV['GAS_API_URL'] || 'https://script.google.com/macros/s/AKfycbwMLJIVKmo2syvFnWKNvke4_VahRwftJFEec6AGSf2jerk7qabHqj_LdCERBTVaGK4d/exec' %>";

    // æœˆã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®åˆæœŸåŒ–
    function initMonthSelector() {
      const select = document.getElementById('month-select');
      const now = new Date();
      
      // ç¾åœ¨æœˆã‹ã‚‰6ãƒ¶æœˆåˆ†ã‚’ç”Ÿæˆ
      for (let i = 0; i < 6; i++) {
        const date = new Date(now.getFullYear(), now.getMonth() + i, 1);
        const yy = String(date.getFullYear()).slice(-2);
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const yymm = yy + mm;
        const displayText = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
        
        const option = document.createElement('option');
        option.value = yymm;
        option.textContent = displayText;
        select.appendChild(option);
      }
    }

    // ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    async function loadShiftData() {
      const month = document.getElementById('month-select').value;
      const contentDiv = document.getElementById('shift-content');
      
      contentDiv.innerHTML = '<p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>';
      
      try {
        const response = await fetch(`${GAS_API_URL}?action=get_shifts&month=${month}`);
        const json = await response.json();
        
        if (json.status === 'success' && json.data) {
          renderShiftTable(json.data);
        } else {
          contentDiv.innerHTML = '<p style="color: red;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
        }
      } catch (error) {
        console.error("Error loading shifts:", error);
        contentDiv.innerHTML = '<p style="color: red;">é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
      }
    }

    // ã‚·ãƒ•ãƒˆè¡¨ã®æç”»
    function renderShiftTable(users) {
      const contentDiv = document.getElementById('shift-content');
      
      if (!users || users.length === 0) {
        contentDiv.innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      // æ—¥ä»˜ã®ä¸€è¦§ã‚’å–å¾—ï¼ˆæœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ï¼‰
      const dates = users[0].shifts ? Object.keys(users[0].shifts).sort((a, b) => parseInt(a) - parseInt(b)) : [];

      let html = '<table class="shift-table"><thead><tr>';
      html += '<th>åå‰</th>';
      dates.forEach(date => {
        html += `<th>${date}æ—¥</th>`;
      });
      html += '</tr></thead><tbody>';

      users.forEach(user => {
        html += '<tr>';
        html += `<td><strong>${user.userName || 'æœªç™»éŒ²'}</strong></td>`;
        dates.forEach(date => {
          const time = user.shifts[date] || '-';
          html += `<td>${time}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      contentDiv.innerHTML = html;
    }

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initMonthSelector();
    });
  </script>
</body>
</html>
