<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‹ã ã¡è¿½åŠ  - QRã‚³ãƒ¼ãƒ‰</title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .container {
      text-align: center;
      background: white;
      padding: 3rem;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px;
    }
    h1 {
      color: #333;
      margin-bottom: 1rem;
      font-size: 2rem;
    }
    .subtitle {
      color: #666;
      margin-bottom: 2rem;
    }
    #qr-container {
      margin: 2rem 0;
      min-height: 300px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #qr-image {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
    }
    .admin-link {
      margin-top: 2rem;
      text-align: center;
    }
    .admin-link a {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
      padding: 0.5rem 1rem;
      border: 2px solid #667eea;
      border-radius: 8px;
      transition: all 0.3s;
    }
    .admin-link a:hover {
      background: #667eea;
      color: white;
    }
    #status-message {
      color: #e74c3c;
      font-weight: bold;
      font-size: 1.2rem;
    }
    .loading {
      color: #667eea;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“± LINEå‹ã ã¡è¿½åŠ </h1>
    <p class="subtitle">ä¸‹è¨˜ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</p>
    
    <div id="qr-container">
      <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
    
    <p id="status-message"></p>
    
    <div class="admin-link">
      <a id="shift-input-link" href="<%= ENV['SPREADSHEET_URL'].presence || 'https://docs.google.com/spreadsheets/d/1WqOsJmpEYnbvMMZAipC_I4ErfMinJKws843xB6G3AIo/' %>" target="_blank">ã‚·ãƒ•ãƒˆå…¥åŠ›ã¯ã“ã¡ã‚‰</a>
    </div>
    <div class="admin-link" style="margin-top: 1rem;">
      <%= link_to "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", admins_logout_path, data: { turbo_method: :delete }, style: "color: #e74c3c; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem; border: 2px solid #e74c3c; border-radius: 8px; display: inline-block;" %>
    </div>
  </div>


  <script>
    // GAS API URL (ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€ã¾ãŸã¯ç›´æ¥æŒ‡å®š)
    const GAS_API_URL = "<%= ENV['GAS_API_URL'] %>";
    // GAS API KEY (ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—)
    const GAS_API_KEY = "<%= ENV['GAS_API_KEY'] %>";

    async function loadOptimalQrCode() {
      try {
        const response = await fetch(`${GAS_API_URL}?action=get_active_qr&api_key=${GAS_API_KEY}`);
        const data = await response.json();

        const qrContainer = document.getElementById('qr-container');
        const statusMessage = document.getElementById('status-message');

        // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
        qrContainer.innerHTML = '';

        if (data.isFull) {
          // å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæº€æ¯ã®å ´åˆï¼šæ‹…å½“è€…ã¸é€£çµ¡ã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          qrContainer.innerHTML = '<p style="font-size:2rem;">âš ï¸</p>';
          statusMessage.innerText = 'å‹é”ç™»éŒ²äººæ•°ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚\nã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºæ‹…å½“è€…ã«ã”é€£çµ¡ãã ã•ã„ã€‚';
          // æ–°æ©Ÿèƒ½ï¼šGASã‹ã‚‰ã€Œå½“æœˆã®ã‚·ãƒ•ãƒˆã‚·ãƒ¼ãƒˆURLï¼ˆgidä»˜ãï¼‰ã€ãŒå±Šã„ã¦ã„ãŸã‚‰ãƒªãƒ³ã‚¯ã‚’æ›¸ãæ›ãˆã‚‹
          if (data.sheetUrl) {
            const shiftLink = document.getElementById('shift-input-link');
            if (shiftLink && shiftLink.href !== data.sheetUrl) {
              shiftLink.href = data.sheetUrl;
            }
          }

        } else if (data.qrUrl) {
          // ç©ºããŒå¾©æ´»ã—ãŸå ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
          statusMessage.innerText = '';
          // ç©ºããŒã‚ã‚‹å ´åˆã€ãã®URLã‚’ä½¿ã£ã¦QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
          new QRCode(qrContainer, {
            text: data.qrUrl,
            width: 200,
            height: 200,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel ? QRCode.CorrectLevel.H : 1
          });

          // æ–°æ©Ÿèƒ½ï¼šGASã‹ã‚‰ã€Œå½“æœˆã®ã‚·ãƒ•ãƒˆã‚·ãƒ¼ãƒˆURLï¼ˆgidä»˜ãï¼‰ã€ãŒå±Šã„ã¦ã„ãŸã‚‰ãƒªãƒ³ã‚¯ã‚’æ›¸ãæ›ãˆã‚‹
          if (data.sheetUrl) {
            const shiftLink = document.getElementById('shift-input-link');
            if (shiftLink && shiftLink.href !== data.sheetUrl) {
              shiftLink.href = data.sheetUrl;
            }
          }
        }
      } catch (error) {
        console.error("Failed to load QR code:", error);
        document.getElementById('qr-container').innerHTML = '<p style="color: red;">QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', loadOptimalQrCode);
    
    // 5ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°ï¼ˆ6äººä»¥ä¸Šã®ç™»éŒ²ã‚’é˜²ããŸã‚ã€GAS APIåˆ¶é™ã‚‚è€ƒæ…®ï¼‰
    setInterval(loadOptimalQrCode, 5000);
  </script>
  <!-- qrcode.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</body>
</html>
