<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‹ã ã¡è¿½åŠ  - QRã‚³ãƒ¼ãƒ‰</title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .container {
      text-align: center;
      background: white;
      padding: 3rem;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 500px;
    }
    h1 {
      color: #333;
      margin-bottom: 1rem;
      font-size: 2rem;
    }
    .subtitle {
      color: #666;
      margin-bottom: 2rem;
    }
    #qr-container {
      margin: 2rem 0;
      min-height: 300px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #qr-image {
      max-width: 100%;
      height: auto;
      border-radius: 10px;
    }
    #status-message {
      color: #e74c3c;
      font-weight: bold;
      font-size: 1.2rem;
    }
    .loading {
      color: #667eea;
      font-size: 1.1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“± LINEå‹ã ã¡è¿½åŠ </h1>
    <p class="subtitle">ä¸‹è¨˜ã®QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„</p>
    
    <div id="qr-container">
      <p class="loading">èª­ã¿è¾¼ã¿ä¸­...</p>
    </div>
    
    <p id="status-message"></p>
  </div>

  <script>
    // GAS API URL (ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€ã¾ãŸã¯ç›´æ¥æŒ‡å®š)
    const GAS_API_URL = "<%= ENV['GAS_API_URL'] || 'https://script.google.com/macros/s/AKfycbwMLJIVKmo2syvFnWKNvke4_VahRwftJFEec6AGSf2jerk7qabHqj_LdCERBTVaGK4d/exec' %>";

    async function loadOptimalQrCode() {
      try {
        const response = await fetch(`${GAS_API_URL}?action=get_active_qr`);
        const data = await response.json();

        const qrContainer = document.getElementById('qr-container');
        const statusMessage = document.getElementById('status-message');

        if (data.isFull) {
          // å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæº€æ¯ã®å ´åˆ
          qrContainer.innerHTML = '';
          statusMessage.innerText = data.message || 'ã™ã¹ã¦ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæº€æ¯ã§ã™';
        } else {
          // ç©ºããŒã‚ã‚‹å ´åˆã€ãã®QRã‚’è¡¨ç¤º
          qrContainer.innerHTML = `<img id="qr-image" src="${data.qrUrl}" alt="LINE QR Code">`;
        }
      } catch (error) {
        console.error("Failed to load QR code:", error);
        document.getElementById('qr-container').innerHTML = '<p style="color: red;">QRã‚³ãƒ¼ãƒ‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', loadOptimalQrCode);
  </script>
</body>
</html>
